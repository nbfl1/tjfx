<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»Ÿè®¡æ³•æ²»å®ˆæŠ¤è€…-å‡çº§ç‰ˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #87CEEB;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 1px solid #000;
            cursor: none;
            display: none;
        }

        .ui-element {
            position: absolute;
            display: none;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #score {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            color: white;
            text-shadow: 2px 2px 4px black;
            display: none;
        }

        #timer {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            color: white;
            text-shadow: 2px 2px 4px black;
            cursor: pointer;
            display: none;
        }

        #toggleRules {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
            font-size: 14px;
        }

        #gameInfo {
            position: absolute;
            width: 80%;
            max-width: 600px;
            display: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #gameInfoInGame {
            position: absolute;
            display: none;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            max-width: 300px;
            font-size: 12px;
            transform: scale(0.8);
            top: 50px;
            right: 10px;
        }

        #difficultySelector {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            text-align: center;
            display: block;
        }

        #difficultySelector button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }

        #historyRecords {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            text-align: center;
            display: none;
        }

        #historyRecords h2 {
            margin-bottom: 10px;
        }

        #historyRecords p {
            margin: 5px 0;
        }

        .high-score {
            color: #FFD700;
        }

        #endGameMenu {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            text-align: center;
            display: none;
        }

        #endGameMenu button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #gameOverScreen {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            display: none;
        }

        #gameOverScreen h2 {
            font-size: 36px;
            margin-bottom: 20px;
        }

        #gameOverScreen p {
            font-size: 24px;
            margin-bottom: 30px;
        }

        #gameOverScreen button {
            padding: 10px 20px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
        }

        #mainMenu {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            text-align: center;
            display: none;
        }

        #mainMenu button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="score">å¾—åˆ†ï¼š0</div>
        <div id="timer">å‰©ä½™æ—¶é—´ï¼š01:00</div>
        <div id="toggleRules">æ¸¸æˆè§„åˆ™</div>
        <div id="gameInfo" class="game-info">
            <h3 style="color: #4CAF50;">ğŸ“œ æ¸¸æˆè§„åˆ™ï¼š</h3>
            <p>ğŸ <span style="color: #4CAF50;">å¥½ç‰©å“ (+10åˆ†)ï¼š</span><br>
                â€¢ ğŸ“Š ä¾æ³•æŠ¥è¡¨ï¼ˆã€Šç»Ÿè®¡æ³•ã€‹ç¬¬äºŒåæ¡ï¼‰<br>
                â€¢ ğŸ“‘ æ•°æ®æ ¸æŸ¥ï¼ˆå®æ–½æ¡ä¾‹ç¬¬å››æ¡ï¼‰<br>
                â€¢ âœ… å®Œæ•´å°è´¦ï¼ˆã€Šç»Ÿè®¡æ³•ã€‹ç¬¬äºŒåä¸€æ¡ï¼‰<br>
                â€¢ ğŸ“š ç»Ÿè®¡æ³•è§„åŸ¹è®­</p>
            <p>ğŸ’£ <span style="color: #FF5252;">åç‰©å“ (-20åˆ†)ï¼š</span><br>
                â€¢ ğŸ’£ ä¼ªé€ èµ„æ–™ï¼ˆæœ€é«˜å¯å¤„20ä¸‡å…ƒç½šæ¬¾ï¼‰<br>
                â€¢ âŒ æŒ‡ä»¤æŠ¥é€ï¼ˆæŸåœ°ç»Ÿè®¡å±€å¹²é¢„æ¡ˆä¾‹ï¼‰<br>
                â€¢ ğŸ’§ æ•°æ®æ³¨æ°´ï¼ˆ2023å¹´æ›å…‰å…¸å‹æ¡ˆä¾‹ï¼‰<br>
                â€¢ ğŸš« æ‹’ç»æä¾›æ•°æ®</p>
            <p style="color: #FFC107;">âš ï¸ æ¥åˆ°4ä¸ªè¿è§„ç‰©å“å°†ç»ˆæ­¢ç»Ÿè®¡èµ„æ ¼ï¼</p>
            <button onclick="hideGameRules()">è¿”å›</button>
        </div>
        
        <div id="gameInfoInGame" class="game-info">
            <h4 style="color: #4CAF50;">ğŸ“œ æ¸¸æˆè§„åˆ™ï¼š</h4>
            <p style="margin: 5px 0;">ğŸ <span style="color: #4CAF50;">å¥½ç‰©å“ (+10åˆ†)ï¼š</span><br>
                â€¢ ğŸ“Š ä¾æ³•æŠ¥è¡¨ï¼ˆã€Šç»Ÿè®¡æ³•ã€‹ç¬¬äºŒåæ¡ï¼‰<br>
                â€¢ ğŸ“‘ æ•°æ®æ ¸æŸ¥ï¼ˆå®æ–½æ¡ä¾‹ç¬¬å››æ¡ï¼‰<br>
                â€¢ âœ… å®Œæ•´å°è´¦ï¼ˆã€Šç»Ÿè®¡æ³•ã€‹ç¬¬äºŒåä¸€æ¡ï¼‰<br>
                â€¢ ğŸ“š ç»Ÿè®¡æ³•è§„åŸ¹è®­</p>
            <p style="margin: 5px 0;">ğŸ’£ <span style="color: #FF5252;">åç‰©å“ (-20åˆ†)ï¼š</span><br>
                â€¢ ğŸ’£ ä¼ªé€ èµ„æ–™ï¼ˆæœ€é«˜å¯å¤„20ä¸‡å…ƒç½šæ¬¾ï¼‰<br>
                â€¢ âŒ æŒ‡ä»¤æŠ¥é€ï¼ˆæŸåœ°ç»Ÿè®¡å±€å¹²é¢„æ¡ˆä¾‹ï¼‰<br>
                â€¢ ğŸ’§ æ•°æ®æ³¨æ°´ï¼ˆ2023å¹´æ›å…‰å…¸å‹æ¡ˆä¾‹ï¼‰<br>
                â€¢ ğŸš« æ‹’ç»æä¾›æ•°æ®</p>
            <p style="color: #FFC107; margin: 5px 0;">âš ï¸ æ¥åˆ°4ä¸ªè¿è§„ç‰©å“å°†ç»ˆæ­¢ç»Ÿè®¡èµ„æ ¼ï¼</p>
            <button onclick="hideInGameRules()">å…³é—­</button>
        </div>
        
        <div id="difficultySelector" class="ui-element">
            <h2>é€‰æ‹©æ¸¸æˆéš¾åº¦</h2>
            <button onclick="startGame('easy')">ç®€å•</button>
            <button onclick="startGame('medium')">ä¸­ç­‰</button>
            <button onclick="startGame('hard')">å›°éš¾</button>
            <button onclick="showMainMenu()">è¿”å›ä¸»èœå•</button>
            <button onclick="showHistoryRecords()">æŸ¥çœ‹å†å²è®°å½•</button>
            <button onclick="showGameRules()">æ¸¸æˆè§„åˆ™</button>
        </div>
        
        <div id="historyRecords" class="ui-element">
            <h2>å†å²è®°å½•</h2>
            <div id="recordList"></div>
            <button onclick="closeHistoryRecords()">å…³é—­</button>
        </div>
        
        <div id="endGameMenu" class="ui-element">
            <h2>æ¸¸æˆç»“æŸ</h2>
            <p id="finalScore">æœ€ç»ˆå¾—åˆ†ï¼š0</p>
            <button onclick="showDifficultySelector()">é‡æ–°é€‰æ‹©éš¾åº¦</button>
            <button onclick="showHistoryRecords()">æŸ¥çœ‹å†å²è®°å½•</button>
            <button onclick="restartGame()">é‡æ–°å¼€å§‹åŒä¸€éš¾åº¦</button>
            <button onclick="showMainMenu()">è¿”å›ä¸»èœå•</button>
            <button onclick="showGameRules()">æ¸¸æˆè§„åˆ™</button>
        </div>
        
        <div id="gameOverScreen" class="ui-element">
            <h2 id="gameOverTitle">æ¸¸æˆç»“æŸ</h2>
            <p id="gameOverScore">æœ€ç»ˆå¾—åˆ†ï¼š0</p>
            <button onclick="showDifficultySelector()">é‡æ–°é€‰æ‹©éš¾åº¦</button>
            <button onclick="showHistoryRecords()">æŸ¥çœ‹å†å²è®°å½•</button>
            <button onclick="restartGame()">é‡æ–°å¼€å§‹åŒä¸€éš¾åº¦</button>
            <button onclick="showMainMenu()">è¿”å›ä¸»èœå•</button>
            <button onclick="showGameRules()">æ¸¸æˆè§„åˆ™</button>
        </div>
        
        <div id="mainMenu" class="ui-element">
            <h2>ä¸»èœå•</h2>
            <button onclick="showDifficultySelector()">å¼€å§‹æ¸¸æˆ</button>
            <button onclick="showHistoryRecords()">æŸ¥çœ‹å†å²è®°å½•</button>
            <button onclick="showGameRules()">æ¸¸æˆè§„åˆ™</button>
            <button onclick="exitGame()">é€€å‡ºæ¸¸æˆ</button>
        </div>
    </div>

    <script>
        // è·å–DOMå…ƒç´ 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const timerElement = document.getElementById('timer');
        const toggleRulesElement = document.getElementById('toggleRules');
        const gameInfoElement = document.getElementById('gameInfo');
        const gameInfoInGameElement = document.getElementById('gameInfoInGame');
        const difficultySelectorElement = document.getElementById('difficultySelector');
        const historyRecordsElement = document.getElementById('historyRecords');
        const endGameMenuElement = document.getElementById('endGameMenu');
        const gameOverScreenElement = document.getElementById('gameOverScreen');
        const mainMenuElement = document.getElementById('mainMenu');
        
        // è®¾ç½®ç”»å¸ƒå°ºå¯¸
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            player: {
                x: canvas.width / 2 - 25,
                y: canvas.height - 80,
                width: 60,
                height: 80,
                expression: 'normal',
                lastExpressionChange: 0,
                speed: 12
            },
            score: 0,
            wrongCount: 0,
            items: [],
            explosions: [],
            gameInterval: null,
            remainingTime: 60,
            baseItemSpeed: 5, // åŸºç¡€ç‰©å“é€Ÿåº¦
            itemSpawnRate: 0.05, // ç‰©å“ç”Ÿæˆé¢‘ç‡
            badItemProbability: 0.5, // åç‰©å“ç”Ÿæˆæ¦‚ç‡
            historyRecords: [],
            highestScore: 0,
            isGameActive: false,
            currentDifficulty: null // å½“å‰éš¾åº¦
        };

        // ç‰©å“å±æ€§
        const GOOD_ITEMS = ['ğŸ“Š', 'ğŸ“‘', 'âœ…', 'ğŸ“š'];
        const BAD_ITEMS = ['ğŸ’£', 'âŒ', 'ğŸ’§', 'ğŸš«'];
        const ITEM_PROPERTIES = {
            'ğŸ“Š': { desc: "ä¾æ³•æŠ¥é€æ•°æ®", score: 10, color: '#4CAF50', case: "æŸä¼ä¸šå› æŒ‰æ—¶å‡†ç¡®æŠ¥é€æ•°æ®è·è¡¨å½°" },
            'ğŸ“‘': { desc: "å®Œæ•´ç»Ÿè®¡å°è´¦", score: 10, color: '#8BC34A', case: "è§„èŒƒå°è´¦ç®¡ç†æœ‰æ•ˆé˜²èŒƒæ•°æ®é£é™©" },
            'âœ…': { desc: "æ•°æ®è´¨é‡æ ¸æŸ¥", score: 10, color: '#CDDC39', case: "å»ºç«‹ä¸‰çº§å®¡æ ¸åˆ¶åº¦ç¡®ä¿æ•°æ®çœŸå®" },
            'ğŸ“š': { desc: "ç»Ÿè®¡æ³•è§„åŸ¹è®­", score: 10, color: '#009688', case: "å¹´åº¦åŸ¹è®­ä½¿å·®é”™ç‡ä¸‹é™60%" },
            'ğŸ’£': { desc: "ä¼ªé€ ç»Ÿè®¡èµ„æ–™", score: -20, color: '#F44336', case: "æŸå…¬å¸ä¼ªé€ æ•°æ®è¢«ç½š18ä¸‡å…ƒ" },
            'âŒ': { desc: "æŒ‡ä»¤æŠ¥é€", score: -20, color: '#FF5722', case: "æŸåœ°ç»Ÿè®¡å±€å¹²é¢„æ¡ˆä¾‹" },
            'ğŸ’§': { desc: "æ•°æ®æ³¨æ°´", score: -20, color: '#795548', case: "2023å¹´æ›å…‰å…¸å‹æ¡ˆä¾‹" },
            'ğŸš«': { desc: "æ‹’ç»æä¾›æ•°æ®", score: -20, color: '#9C27B0', case: "æŸå•ä½æ‹’æŠ¥è¢«åˆ—å…¥å¤±ä¿¡åå•" }
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame(difficulty) {
            gameState.currentDifficulty = difficulty;

            // æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´æ¸¸æˆé€Ÿåº¦
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            let speedMultiplier = 1.0;
            let itemSpawnMultiplier = 1.0;
            if (isMobile) {
                speedMultiplier = 0.5; // ç§»åŠ¨è®¾å¤‡ä¸Šå‡æ…¢é€Ÿåº¦
            } else {
                speedMultiplier = 1.5; // ç”µè„‘ä¸ŠåŠ å¿«é€Ÿåº¦
                itemSpawnMultiplier = 1.2; // ç”µè„‘ä¸Šå¢åŠ ç‰©å“ç”Ÿæˆé¢‘ç‡
                gameState.player.speed = 18; // ç”µè„‘ä¸Šå¢åŠ äººç‰©ç§»åŠ¨é€Ÿåº¦
            }

            // æ ¹æ®éš¾åº¦è®¾ç½®æ¸¸æˆå‚æ•°
            switch (difficulty) {
                case 'easy':
                    gameState.baseItemSpeed = 4 * speedMultiplier;
                    gameState.itemSpawnRate = 0.02 * itemSpawnMultiplier;
                    gameState.badItemProbability = 0.2;
                    gameState.remainingTime = 120;
                    break;
                case 'medium':
                    gameState.baseItemSpeed = 6 * speedMultiplier;
                    gameState.itemSpawnRate = 0.04 * itemSpawnMultiplier;
                    gameState.badItemProbability = 0.35;
                    gameState.remainingTime = 90;
                    break;
                case 'hard':
                    gameState.baseItemSpeed = 8 * speedMultiplier;
                    gameState.itemSpawnRate = 0.06 * itemSpawnMultiplier;
                    gameState.badItemProbability = 0.5;
                    gameState.remainingTime = 60;
                    break;
            }

            gameState.player.x = canvas.width / 2 - 25;
            gameState.player.y = canvas.height - 80;
            gameState.player.expression = 'normal';
            gameState.score = 0;
            gameState.wrongCount = 0;
            gameState.items = [];
            gameState.explosions = [];
            gameState.isGameActive = true;
            
            // ç¡®ä¿æ¸¸æˆè§„åˆ™ç•Œé¢åˆå§‹ä¸ºéšè—çŠ¶æ€
            gameInfoInGameElement.style.display = 'none';
            
            // æ ¹æ®å±å¹•é«˜åº¦è°ƒæ•´ç‰©å“ä¸‹è½é€Ÿåº¦
            gameState.baseItemSpeed *= (canvas.height / 600);
            
            scoreElement.textContent = `å¾—åˆ†ï¼š${gameState.score}`;
            updateTimer();
            
            if (gameState.gameInterval) {
                clearInterval(gameState.gameInterval);
            }
            
            gameState.gameInterval = setInterval(() => {
                gameState.remainingTime--;
                updateTimer();
                
                if (gameState.remainingTime <= 0) {
                    endGame();
                }
            }, 1000);
            
            showScreen('game');
            gameLoop();
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame(difficulty) {
            difficultySelectorElement.style.display = 'none';
            initGame(difficulty);
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!gameState.isGameActive) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç©å®¶
            drawPlayer();
            
            // ç”Ÿæˆæ–°ç‰©å“
            if (Math.random() < gameState.itemSpawnRate) {
                gameState.items.push(createItem());
            }
            
            // æ›´æ–°ç‰©å“å’Œæ•ˆæœ
            updateItems();
            updateExplosions();
            
            requestAnimationFrame(gameLoop);
        }

        // ç»˜åˆ¶ç©å®¶
        function drawPlayer() {
            const p = gameState.player;
            
            // èº«ä½“
            ctx.fillStyle = '#2196F3';
            ctx.fillRect(p.x, p.y + 20, p.width, 60);
            
            // å¤´éƒ¨
            ctx.beginPath();
            ctx.arc(p.x + 30, p.y, 20, 0, Math.PI * 2);
            ctx.fillStyle = '#FFE0B2';
            ctx.fill();
            
            // è¡¨æƒ…
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            
            // çœ¼ç›
            ctx.beginPath();
            ctx.arc(p.x + 20, p.y - 5, 3, 0, Math.PI * 2);
            ctx.arc(p.x + 40, p.y - 5, 3, 0, Math.PI * 2);
            ctx.stroke();
            
            // å˜´å·´
            ctx.beginPath();
            if (p.expression === 'happy') {
                ctx.arc(p.x + 30, p.y + 5, 8, 0, Math.PI);
            } else if (p.expression === 'angry') {
                ctx.moveTo(p.x + 20, p.y + 10);
                ctx.lineTo(p.x + 40, p.y + 5);
            } else {
                ctx.moveTo(p.x + 20, p.y + 8);
                ctx.lineTo(p.x + 40, p.y + 8);
            }
            ctx.stroke();
        }

        // ç”Ÿæˆæ–°ç‰©å“
        function createItem() {
            const allItems = [...GOOD_ITEMS, ...BAD_ITEMS];
            // æ ¹æ®åç‰©å“æ¦‚ç‡å†³å®šç‰©å“ç±»å‹
            const isBadItem = Math.random() < gameState.badItemProbability;
            const type = isBadItem ? BAD_ITEMS[Math.floor(Math.random() * BAD_ITEMS.length)] : GOOD_ITEMS[Math.floor(Math.random() * GOOD_ITEMS.length)];
            return {
                x: Math.random() * (canvas.width - 30),
                y: 0,
                type: type,
                speed: gameState.baseItemSpeed
            };
        }

        // æ›´æ–°ç‰©å“çŠ¶æ€
        function updateItems() {
            for (let i = gameState.items.length - 1; i >= 0; i--) {
                const item = gameState.items[i];
                item.y += item.speed;
                
                // ç»˜åˆ¶ç‰©å“
                ctx.fillStyle = ITEM_PROPERTIES[item.type].color;
                ctx.font = '30px Arial';
                ctx.fillText(item.type, item.x, item.y);
                
                // ç¢°æ’æ£€æµ‹
                if (checkCollision(gameState.player, item)) {
                    handleCollision(item);
                    gameState.items.splice(i, 1);
                    continue;
                }
                
                // ç§»é™¤è¶…å‡ºå±å¹•çš„ç‰©å“
                if (item.y > canvas.height) {
                    gameState.items.splice(i, 1);
                }
            }
        }

        // å¤„ç†ç¢°æ’
        function handleCollision(item) {
            gameState.score += ITEM_PROPERTIES[item.type].score;
            scoreElement.textContent = `å¾—åˆ†ï¼š${gameState.score}`;
            
            if (ITEM_PROPERTIES[item.type].score > 0) {
                gameState.player.expression = 'happy';
            } else {
                gameState.player.expression = 'angry';
                gameState.wrongCount++;
                createExplosion(item.x, item.y);
                
                if (gameState.wrongCount >= 4) {
                    endGame();
                }
            }
            
            gameState.player.lastExpressionChange = Date.now();
            
            setTimeout(() => {
                if (Date.now() - gameState.player.lastExpressionChange > 3000) {
                    gameState.player.expression = 'normal';
                }
            }, 3000);
        }

        // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
        function createExplosion(x, y) {
            gameState.explosions.push({
                x: x,
                y: y,
                radius: 5,
                maxRadius: 30,
                alpha: 1
            });
        }

        // æ›´æ–°çˆ†ç‚¸æ•ˆæœ
        function updateExplosions() {
            for (let i = gameState.explosions.length - 1; i >= 0; i--) {
                const explosion = gameState.explosions[i];
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 87, 34, ${explosion.alpha})`;
                ctx.fill();
                
                explosion.radius += 1;
                explosion.alpha -= 0.03;
                
                if (explosion.alpha <= 0) {
                    gameState.explosions.splice(i, 1);
                }
            }
        }

        // ç¢°æ’æ£€æµ‹
        function checkCollision(player, item) {
            return (
                player.x < item.x + 30 &&
                player.x + player.width > item.x &&
                player.y < item.y + 30 &&
                player.y + player.height > item.y
            );
        }

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            const minutes = Math.floor(gameState.remainingTime / 60);
            const seconds = gameState.remainingTime % 60;
            timerElement.textContent = `å‰©ä½™æ—¶é—´ï¼š${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // ç»“æŸæ¸¸æˆ
        function endGame() {
            gameState.isGameActive = false;
            clearInterval(gameState.gameInterval);
            
            // ä¿å­˜å¾—åˆ†
            gameState.historyRecords.unshift(gameState.score);
            if (gameState.historyRecords.length > 5) {
                gameState.historyRecords.pop();
            }
            gameState.highestScore = Math.max(...gameState.historyRecords);
            
            // éšè—æ¸¸æˆè§„åˆ™ç•Œé¢
            gameInfoInGameElement.style.display = 'none';
            
            showScreen('gameOver');
        }

        // æ˜¾ç¤º/éšè—è§„åˆ™
        toggleRulesElement.addEventListener('click', () => {
            if (!gameState.isGameActive) {
                // æ¸¸æˆæœªå¼€å§‹æ—¶ï¼Œå±…ä¸­æ˜¾ç¤ºè§„åˆ™
                gameInfoElement.style.display = gameInfoElement.style.display === 'none' ? 'block' : 'none';
                gameInfoElement.style.top = '50%';
                gameInfoElement.style.left = '50%';
                gameInfoElement.style.transform = 'translate(-50%, -50%)';
            } else {
                // æ¸¸æˆè¿›è¡Œä¸­ï¼Œåˆ‡æ¢è§„åˆ™ç•Œé¢çš„æ˜¾ç¤ºçŠ¶æ€
                if (gameInfoInGameElement.style.display === 'none') {
                    gameInfoInGameElement.style.display = 'block';
                    
                    // è®¾ç½®ä½ç½®ä¸ºæŒ‰é’®ä¸‹æ–¹
                    const rulesButtonRect = toggleRulesElement.getBoundingClientRect();
                    gameInfoInGameElement.style.top = `${rulesButtonRect.bottom + 10}px`;
                    gameInfoInGameElement.style.right = `${window.innerWidth - rulesButtonRect.right + 10}px`;
                } else {
                    gameInfoInGameElement.style.display = 'none';
                }
            }
        });

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            const speed = gameState.player.speed;
            switch (e.key) {
                case 'ArrowLeft':
                case 'a':
                    gameState.player.x = Math.max(0, gameState.player.x - speed);
                    break;
                case 'ArrowRight':
                case 'd':
                    gameState.player.x = Math.min(canvas.width - gameState.player.width, gameState.player.x + speed);
                    break;
                case 'ArrowUp':
                case 'w':
                    gameState.player.y = Math.max(0, gameState.player.y - speed);
                    break;
                case 'ArrowDown':
                case 's':
                    gameState.player.y = Math.min(canvas.height - gameState.player.height, gameState.player.y + speed);
                    break;
            }
        });

        // è§¦å±æ§åˆ¶
        let touchStartX = 0;
        let touchStartY = 0;

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;

            const deltaX = touchX - touchStartX;
            const deltaY = touchY - touchStartY;

            gameState.player.x = Math.max(0, Math.min(canvas.width - gameState.player.width, gameState.player.x + deltaX));
            gameState.player.y = Math.max(0, Math.min(canvas.height - gameState.player.height, gameState.player.y + deltaY));

            touchStartX = touchX;
            touchStartY = touchY;
        });

        // ç‚¹å‡»å…³é—­è§„åˆ™
        gameInfoElement.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                gameInfoElement.style.display = 'none';
                showScreen('mainMenu');
            }
        });

        gameInfoInGameElement.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                gameInfoInGameElement.style.display = 'none';
            }
        });

        // æ˜¾ç¤ºæŒ‡å®šç•Œé¢
        function showScreen(screenName) {
            // éšè—æ‰€æœ‰ç•Œé¢
            const allScreens = [
                'gameCanvas', 'score', 'timer', 'toggleRules', 'gameInfo',
                'gameInfoInGame', 'difficultySelector', 'historyRecords', 'endGameMenu',
                'gameOverScreen', 'mainMenu'
            ];
            
            allScreens.forEach(screen => {
                if (screen !== 'gameInfoInGame') {
                    document.getElementById(screen).style.display = 'none';
                }
            });
            
            // æ˜¾ç¤ºæŒ‡å®šç•Œé¢
            if (screenName === 'game') {
                document.getElementById('gameCanvas').style.display = 'block';
                document.getElementById('score').style.display = 'block';
                document.getElementById('timer').style.display = 'block';
                document.getElementById('toggleRules').style.display = 'block';
            } else if (screenName === 'gameOver') {
                document.getElementById('gameOverScreen').style.display = 'flex';
                document.getElementById('gameOverScore').textContent = `æœ€ç»ˆå¾—åˆ†ï¼š${gameState.score}`;
            } else {
                document.getElementById(screenName).style.display = 'block';
            }
        }

        // æŸ¥çœ‹å†å²è®°å½•
        function showHistoryRecords() {
            const recordList = document.getElementById('recordList');
            recordList.innerHTML = '';
            
            gameState.historyRecords.forEach((record, index) => {
                const p = document.createElement('p');
                if (record === gameState.highestScore) {
                    p.classList.add('high-score');
                    p.textContent = `ç¬¬ ${index + 1} æ¬¡ï¼š${record}ï¼ˆæœ€é«˜å¾—åˆ†ï¼‰`;
                } else {
                    p.textContent = `ç¬¬ ${index + 1} æ¬¡ï¼š${record}`;
                }
                recordList.appendChild(p);
            });
            
            showScreen('historyRecords');
        }

        // å…³é—­å†å²è®°å½•
        function closeHistoryRecords() {
            showScreen('endGameMenu');
        }

        // æ˜¾ç¤ºéš¾åº¦é€‰æ‹©ç•Œé¢
        function showDifficultySelector() {
            showScreen('difficultySelector');
        }

        // æ˜¾ç¤ºä¸»èœå•
        function showMainMenu() {
            showScreen('mainMenu');
        }

        // æ˜¾ç¤ºæ¸¸æˆè§„åˆ™
        function showGameRules() {
            // éšè—å½“å‰æ˜¾ç¤ºçš„ç•Œé¢
            const currentScreens = [
                'difficultySelector', 'endGameMenu', 'gameOverScreen', 'mainMenu'
            ];
            currentScreens.forEach(screen => {
                document.getElementById(screen).style.display = 'none';
            });
            
            // æ˜¾ç¤ºæ¸¸æˆè§„åˆ™ç•Œé¢
            gameInfoElement.style.display = 'block';
            gameInfoElement.style.top = '50%';
            gameInfoElement.style.left = '50%';
            gameInfoElement.style.transform = 'translate(-50%, -50%)';
        }

        // éšè—æ¸¸æˆè§„åˆ™
        function hideGameRules() {
            gameInfoElement.style.display = 'none';
            showScreen('mainMenu');
        }

        // éšè—æ¸¸æˆä¸­çš„è§„åˆ™
        function hideInGameRules() {
            gameInfoInGameElement.style.display = 'none';
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            if (gameState.currentDifficulty) {
                initGame(gameState.currentDifficulty);
            }
        }

        // é€€å‡ºæ¸¸æˆ
        function exitGame() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ é€€å‡ºé€»è¾‘ï¼Œæ¯”å¦‚è¿”å›åˆ°ä¸»èœå•æˆ–å®Œå…¨å…³é—­åº”ç”¨
            showScreen('mainMenu');
        }

        // åˆå§‹æ˜¾ç¤ºä¸»èœå•
        showScreen('mainMenu');
    </script>
</body>
</html>